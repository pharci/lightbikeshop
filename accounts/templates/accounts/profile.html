{% extends "core/base.html" %}
{% load static %}

{% block title %}Профиль{% endblock %}

{% block styles %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'accounts/css/profile.css' %}">
{% endblock %}

{% block content %}
<div class="container profile">

  {# ——— Модалка подтверждения отмены ——— #}
  <div id="confirmationOverlay" class="overlay">
    <div class="overlay__content">
      <h2 class="overlay__title">Отменить заказ?</h2>
      <p class="overlay__text">Вернуть заказ уже не получится.</p>
      <div class="overlay__actions">
        <button id="confirmBtn" class="btn btn--danger">Отменить заказ</button>
        <button id="cancelBtn" class="btn">Назад</button>
      </div>
    </div>
  </div>

  <div class="profile__grid">
    {# ——— Левая колонка: Профиль ——— #}
    <aside class="card">

      <div class="profile__box">
        <div class="profile__row">
          <span class="profile__label">Почта</span>
          <span class="profile__value">{% if user.email %} {{ user.email }} {% else %} Нет {% endif %}</span>
        </div>
        <div class="profile__row">
          <span class="profile__label">Телеграм</span>
          <span class="profile__value">
            {% if user.telegram_id %}
              <a href="https://t.me/{{ user.telegram_username }}" target="_blank">
                @{{ user.telegram_username }}
              </a>
            {% else %}
              Нет
            {% endif %}
          </span>
        </div>

        <a class="btn btn--dark btn--block" href="{% url 'accounts:logout' %}">Выйти</a>
      </div>
    </aside>

    {# ——— Правая колонка: Заказы ——— #}
    <main class="orders">
      <div class="section__header">
        <h2 class="section__title">Заказы</h2>
      </div>

      {# Активные заказы #}
      {% for order in orders|dictsortreversed:"date_ordered" %}
        {% if order.status != 'canceled' and order.status != 'completed' %}
          <article class="order card" id="{{ order.order_id }}">
            <header class="order__head">
              <h3 class="order__title">Заказ № {{ order.order_id }}</h3>
              <span class="badge
                          {% if order.status == 'created' %}badge--info
                          {% elif order.status == 'processing' %}badge--warn
                          {% elif order.status == 'completed' %}badge--ok
                          {% elif order.status == 'canceled' %}badge--danger
                          {% else %}badge--muted{% endif %}">
                {{ order.get_status_display }}
              </span>
            </header>

            <div class="order__meta">
              <div class="order__row">
                <span class="order__label">Дата оформления</span>
                <span class="order__value">{{ order.date_ordered|date:"d.n.Y, H:i" }}</span>
              </div>

              {% if order.receiving_method == 'pickup' %}
                <div class="order__row">
                  <span class="order__label">Метод получения</span>
                  <span class="order__value">Самовывоз</span>
                </div>
                <div class="order__row">
                  <span class="order__label">Пункт самовывоза</span>
                  <span class="order__value">Метро {{ order.get_pickup_location_display }}</span>
                </div>
              {% else %}
                <div class="order__row">
                  <span class="order__label">Метод получения</span>
                  <span class="order__value">Доставка</span>
                </div>
                <div class="order__row">
                  <span class="order__label">Адрес</span>
                  <span class="order__value">{{ order.delivery_address }}</span>
                </div>
                <div class="order__row">
                  <span class="order__label">Способ доставки</span>
                  <span class="order__value">{{ order.get_delivery_method_display }}</span>
                </div>
              {% endif %}
            </div>

            <div class="order__items">
              <div class="order__subhead">Товары</div>
              <ul class="order-list">
                {% for item in order.items.all %}
                  <li class="order-list__item">
                    <a class="order-list__name" href="{{ item.variant.product.get_absolute_url }}?sku={{ item.variant.sku|urlencode }}">
                      {{ item.variant.display_name }}
                    </a>
                    <span class="order-list__qty">{{ item.quantity }} шт.</span>
                    <span class="order-list__price">{{ item.variant.price|floatformat:0 }}₽</span>
                  </li>
                {% endfor %}
              </ul>
            </div>

            <footer class="order__foot">
              <div class="order__totals">
                <div class="order__row">
                  <span class="order__label">Количество товаров</span>
                  <span class="order__value">{{ order.get_total_count }}</span>
                </div>
                <div class="order__row">
                  <span class="order__label">Итоговая цена</span>
                  <span class="order__value">{{ order.get_total_price|floatformat:0 }}₽</span>
                </div>
              </div>

              <div class="order__actions">
                <a href="https://t.me/light_bikeshop" class="btn">Помощь</a>
                {% if order.status == 'created' %}
                  <button
                    class="btn btn--danger cancel_order"
                    data-order-id="{{ order.order_id }}"
                    id="buttom-{{ order.order_id }}">
                    Отменить
                  </button>
                {% endif %}
              </div>
            </footer>
          </article>
        {% endif %}
      {% endfor %}

      {# История заказов #}
      <div class="section__header">
        <button class="btn btn--dark history-toggle" id="dropdown-button">
          <svg class="history-toggle__chev" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M7 10l5 5 5-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <span id="history-button-text">Показать историю</span>
          <span id="history-count-badge" class="badge badge--muted" style="margin-left:6px; font-size:11px;">0</span>
        </button>
      </div>

      <div id="dropdown-container" class="orders__history">
        {% for order in orders|dictsortreversed:"date_ordered" %}
          {% if order.status == 'canceled' or order.status == 'completed' %}
            <article class="order card" id="{{ order.order_id }}">
              <header class="order__head">
                <h3 class="order__title">Заказ № {{ order.order_id }}</h3>
                <span class="badge
                            {% if order.status == 'completed' %}badge--ok
                            {% else %}badge--danger{% endif %}">
                  {{ order.get_status_display }}
                </span>
              </header>

              <div class="order__meta">
                <div class="order__row">
                  <span class="order__label">Дата оформления</span>
                  <span class="order__value">{{ order.date_ordered|date:"d.n.Y, H:i" }}</span>
                </div>

                {% if order.receiving_method == 'pickup' %}
                  <div class="order__row">
                    <span class="order__label">Метод получения</span>
                    <span class="order__value">Самовывоз</span>
                  </div>
                  <div class="order__row">
                    <span class="order__label">Пункт самовывоза</span>
                    <span class="order__value">Метро {{ order.get_pickup_location_display }}</span>
                  </div>
                {% else %}
                  <div class="order__row">
                    <span class="order__label">Метод получения</span>
                    <span class="order__value">Доставка</span>
                  </div>
                  <div class="order__row">
                    <span class="order__label">Адрес</span>
                    <span class="order__value">{{ order.delivery_address }}</span>
                  </div>
                  <div class="order__row">
                    <span class="order__label">Способ доставки</span>
                    <span class="order__value">{{ order.get_delivery_method_display }}</span>
                  </div>
                {% endif %}
              </div>

              <div class="order__items">
                <div class="order__subhead">Товары</div>
                <ul class="order-list">
                  {% for item in order.items.all %}
                    <li class="order-list__item">
                      <a class="order-list__name" href="{{ item.variant.product.get_absolute_url }}?sku={{ item.variant.sku|urlencode }}">
                        {{ item.variant.display_name }}
                      </a>
                      <span class="order-list__qty">{{ item.quantity }} шт.</span>
                      <span class="order-list__price">{{ item.variant.price|floatformat:0 }}₽</span>
                    </li>
                  {% endfor %}
                </ul>
              </div>

              <footer class="order__foot">
                <div class="order__totals">
                  <div class="order__row">
                    <span class="order__label">Количество товаров</span>
                    <span class="order__value">{{ order.get_total_count }}</span>
                  </div>
                  <div class="order__row">
                    <span class="order__label">Итоговая цена</span>
                    <span class="order__value">{{ order.get_total_price|floatformat:0 }}₽</span>
                  </div>
                </div>
              </footer>
            </article>
          {% endif %}
        {% endfor %}
      </div>
    </main>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ block.super }}
  <script src="{% static 'accounts/js/profile.js' %}"></script>
{% endblock %}
