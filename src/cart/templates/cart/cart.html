{% extends "core/base.html" %}{% load static %}
{% block title %}Корзина{% endblock %}
{% block styles %}{{ block.super }}<link rel="stylesheet" href="{% static 'cart/css/style.css' %}">{% endblock %}
{% block content %}
<div class="container">
  <div class="page-grid">
    <section id="cart-items" class="cart-items" aria-live="polite"></section>

    <aside class="order-summary">
      <div class="order-summary__row">
        <span id="cart-total-count">{{ cart.get_total_items }}</span>
        <div class="filler-underline"></div>
        <span id="cart-subtotal-price">{{ cart.get_cart_subtotal_price|floatformat:2 }} ₽</span>
      </div>

      <div class="promo">
        <form method="post" action="{% url 'cart:apply_promo' %}" class="promo__inline">
          {% csrf_token %}
          <input name="promo_code" placeholder="Введите промокод" class="promo__input" value="{% if cart.get_promo_obj %}{{ cart.get_promo_obj.code }}{% endif %}">
          <button class="btn">Применить</button>
        </form>
        {% if cart.get_promo_obj %}
          <div class="promo__chip">
            Промокод: <strong>{{ cart.get_promo_obj.code }}{% if cart.get_promo_obj.discount_type == "percent" %} - {{ cart.get_promo_obj.amount|floatformat:2 }}%{% else %} - {{ cart.get_promo_obj.amount|floatformat:2 }}₽{% endif %}</strong>
            <form method="post" action="{% url 'cart:remove_promo' %}" class="promo__remove-form">
              {% csrf_token %}<button class="promo__remove" aria-label="Удалить">&times;</button>
            </form>
          </div>
        {% endif %}
      </div>

      <hr class="order-summary__hr">

      <div class="order-summary__total">
        <span>Итого к оплате</span>
        <div class="filler-underline"></div>
        <span id="cart-total-price">{{ cart.get_cart_total_price|floatformat:2 }} ₽</span>
      </div>

      {% if not request.user.is_authenticated %}
        <a class="btn btn--disabled" href="#" aria-disabled="true">Оформить заказ</a>
        <div class="note note--danger">
          Чтобы оформить заказ, <a class="link" href="{% url 'accounts:login' %}?next={% url 'cart:checkout' %}">войдите в аккаунт</a>.
        </div>

      {% elif cart.get_total_items|default:0 <= 0 %}
        <a class="btn btn--disabled" href="#" aria-disabled="true">Оформить заказ</a>
        <div class="note note--danger">В корзине пусто. Добавьте товары.</div>

      {% else %}
        <a id="checkout-btn" class="btn" href="{% url 'cart:checkout' %}">Оформить заказ</a>
      {% endif %}

      {% for message in messages %}
        {% if message.level_tag == 'error' and 'global' in message.tags %}
          <p class="field__error">{{ message }}</p>
        {% endif %}
      {% endfor %}
    </aside>
  </div>
  <template id="tpl-cart-empty"><div class="cart-empty"><div class="cart-empty__title">В корзине пусто</div><div class="cart-empty__text">Добавьте товары, чтобы оформить заказ.</div></div></template>
</div>
{% endblock %}
{% block scripts %}{{ block.super }}<script src="{% static 'cart/js/cart.js' %}"></script>{% endblock %}
